@echo off
REM Invoice2X Simple Pro - Installer Build Script for Windows
REM Creates .exe and .msi installers

echo ================================================
echo Invoice2X Simple Pro - Installer Builder
echo ================================================
echo.

REM Check Java version
java -version 2>&1 | findstr /R "version" > temp.txt
set /p JAVA_VERSION_LINE=<temp.txt
del temp.txt

echo Java found: %JAVA_VERSION_LINE%
echo.

REM Build with Maven
echo Step 1: Building application with Maven...
call mvn clean package

if %ERRORLEVEL% NEQ 0 (
    echo ERROR: Maven build failed!
    pause
    exit /b 1
)

echo Build successful!
echo.

REM Create installer directories
echo Step 2: Preparing installer files...
if not exist installer\input mkdir installer\input
if not exist installer\output mkdir installer\output

REM Copy JAR with dependencies
copy target\invoice2x-simple-pro-1.0.0-jar-with-dependencies.jar installer\input\invoice2x.jar

REM Check for icon
if not exist resources\icons\invoice2x-icon.ico (
    echo WARNING: Icon file not found at resources\icons\invoice2x-icon.ico
    echo Please create an icon file before building installer
    echo You can use online tools like: https://convertio.co/png-ico/
    echo.
    echo For now, installer will be created without custom icon.
    echo.
)

echo Files prepared!
echo.

REM Build EXE installer (requires WiX Toolset)
echo Step 3: Building Windows installer...
echo.

jpackage ^
    --input installer\input ^
    --name "Invoice2X" ^
    --main-jar invoice2x.jar ^
    --main-class com.invoice2x.Main ^
    --type exe ^
    --dest installer\output ^
    --app-version 1.0.0 ^
    --vendor "Invoice2X" ^
    --description "Professional invoice management with Excel export" ^
    --win-dir-chooser ^
    --win-menu ^
    --win-menu-group "Invoice2X" ^
    --win-shortcut ^
    --win-shortcut-prompt ^
    --java-options "-Xms256m" ^
    --java-options "-Xmx1024m"

if %ERRORLEVEL% EQU 0 (
    echo EXE installer created successfully!
) else (
    echo WARNING: EXE installer creation failed
    echo Make sure WiX Toolset is installed: https://wixtoolset.org/
)

echo.

REM Build MSI installer (alternative)
echo Step 4: Building MSI installer...
echo.

jpackage ^
    --input installer\input ^
    --name "Invoice2X" ^
    --main-jar invoice2x.jar ^
    --main-class com.invoice2x.Main ^
    --type msi ^
    --dest installer\output ^
    --app-version 1.0.0 ^
    --vendor "Invoice2X" ^
    --description "Professional invoice management with Excel export" ^
    --win-dir-chooser ^
    --win-menu ^
    --win-menu-group "Invoice2X" ^
    --win-shortcut ^
    --win-shortcut-prompt ^
    --java-options "-Xms256m" ^
    --java-options "-Xmx1024m"

if %ERRORLEVEL% EQU 0 (
    echo MSI installer created successfully!
) else (
    echo WARNING: MSI installer creation failed
    echo Make sure WiX Toolset is installed: https://wixtoolset.org/
)

echo.
echo ================================================
echo Build Complete!
echo ================================================
echo.

REM List created files
if exist installer\output (
    echo Created installers:
    dir installer\output\*.exe installer\output\*.msi 2>nul
    echo.
    
    echo Installation:
    echo   Double-click the .exe or .msi file to install
    echo   Follow the installation wizard
    echo   Invoice2X will appear in Start Menu
    echo.
)

echo.
echo Done!
pause